<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD iBatis Mapper 3.0 //EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="gob.dp.simco.reporte.dao.ReporteSimcoActorDao">
    
    <resultMap id="reporteSimcoActorMap" type="reporteSimcoActor">
        <result property="codigoCaso" column="C_CODIGOCASO"/>
        <result property="nombreCaso" column="C_NOMCASO"/>
        <result property="fechaInicioCaso" column="FECHA_INICIO"/>
        <result property="regionPrincial" column="C_DESCDPTO"/>
        <result property="tipologia" column="TIPOCASO"/>
        <result property="estado" column="TIPOESTADO"/>
        <result property="actividad" column="TIPOACTIVIDAD"/>
        <result property="fase" column="FASE"/>
        <result property="acuerdos" column="ACUERDOS"/>
    </resultMap>      

    <select id="reporteActor" parameterType="reporteSimcoActor"  resultMap="reporteSimcoActorMap">
        SELECT DISTINCT A.C_CODIGOCASO, A.C_NOMCASO, TO_CHAR(A.D_FECHAPUBLICACION, 'dd/mm/yyyy') FECHA_INICIO, 
B.C_DESCDPTO, C.NOMBRE_PARAMETRO TIPOCASO, D.NOMBRE_PARAMETRO TIPOESTADO, E.NOMBRE_PARAMETRO TIPOACTIVIDAD, 
F.NOMBRE_PARAMETRO FASE, G.ACUERDOS 
FROM SIMCO_REG_CASO A
LEFT JOIN SIMCO_UBIGEO_DPTO B ON A.C_IDDEPART = B.C_ID_DPTO
LEFT JOIN SIMCO_PARAMETRO C ON C.VALOR_PARAMETRO = A.C_TIPOCASO AND C.PADRE_PARAMETRO = 90
LEFT JOIN SIMCO_PARAMETRO D ON D.VALOR_PARAMETRO = A.C_TIPOESTADO AND D.PADRE_PARAMETRO = 120
LEFT JOIN SIMCO_PARAMETRO E ON E.VALOR_PARAMETRO = A.C_SUBTIPOCASO AND E.PADRE_PARAMETRO = 130
LEFT JOIN SIMCO_PARAMETRO F ON F.VALOR_PARAMETRO = A.C_TIPODIALOGO AND F.PADRE_PARAMETRO = 210
LEFT JOIN (
SELECT COUNT(*) ACUERDOS, D1.N_ID_CASO FROM SIMCO_REG_DET_ACTA_ACUERDO A1
INNER JOIN SIMCO_REG_ACTA_ACUERDO B1 ON A1.N_ID_ACTA = B1.N_ID_ACTA
INNER JOIN SIMCO_REG_ACTIVIDAD_ACTAS C1 ON B1.N_ID_ACTA = C1.N_ID_ACTA
INNER JOIN SIMCO_REG_CASO_ACTIVIDAD D1 ON C1.N_ID_ACTIVIDAD = D1.N_ID_ACTIVIDAD
GROUP BY D1.N_ID_CASO
) G ON A.N_ID_CASO = G.N_ID_CASO
LEFT JOIN (
SELECT A2.C_TIPOACONTECIMIENTO, B2.N_ID_CASO, A2.N_ID_ACTIVIDAD FROM SIMCO_REG_ACTIVIDAD A2
INNER JOIN SIMCO_REG_CASO_ACTIVIDAD B2 ON A2.N_ID_ACTIVIDAD = B2.N_ID_ACTIVIDAD
) J ON A.N_ID_CASO = J.N_ID_CASO 
LEFT JOIN SIMCO_REG_ACTIVIDAD_ACTOR K ON J.N_ID_ACTIVIDAD = K.N_ID_ACTIVIDAD       
LEFT JOIN SIMCO_REG_ACTOR L ON K.N_ID_ACTOR = L.N_ID_ACTOR         
WHERE A.C_INDVIGENTE = 'A' AND A.D_FECHAPUBLICACION IS NOT NULL
        <if test="anho != 0">
                AND TO_CHAR(A.D_FECHAPUBLICACION, 'yyyy') = #{anho} 
            </if>
        <if test="tipologia != 0">
                AND A.C_TIPOCASO = #{tipologia} 
            </if>
        <if test="estado != 0">
                AND A.C_TIPOESTADO = #{estado} 
            </if> 
        <if test="idRegion != 0">
                AND A.C_IDDEPART = #{idRegion} 
            </if> 
        <if test="tipoAcontecimiento != 0">
                AND J.C_TIPOACONTECIMIENTO = #{tipoAcontecimiento} 
            </if>
        <if test="idActor != null">
                AND K.N_ID_ACTOR = #{idActor} 
            </if>
        <if test="tipoActor != 'NN'">
                AND L.C_TIPOGENERAL = #{tipoActor} 
            </if>                          
    </select>
    
</mapper>