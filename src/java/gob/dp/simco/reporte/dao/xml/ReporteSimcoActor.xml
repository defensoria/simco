<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD iBatis Mapper 3.0 //EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="gob.dp.simco.reporte.dao.ReporteSimcoActorDao">
    
    <resultMap id="reporteSimcoActorMap" type="reporteSimcoActor">
        <result property="nombreActor" column="NOMACTOR"/>
        <result property="tipoActor" column="C_TIPOGENERAL"/>
        <result property="nombreDepartamento" column="C_DESCDPTO"/>
        <result property="idActor" column="N_ID_ACTOR"/>
        <result property="documento" column="N_ID_ACTOR"/>
        <result property="ruc" column="C_RUCACTOR"/>
    </resultMap>      

    <select id="reporteActor" parameterType="reporteSimcoActor"  resultMap="reporteSimcoActorMap">
        SELECT DISTINCT A.C_NOMACTOR||' '||nvl(A.C_APELLIDOPATACTOR, '')||' '||nvl(A.C_APELLIDOMATACTOR, '') NOMACTOR, A.C_TIPOGENERAL, 
        B.C_DESCDPTO, A.N_ID_ACTOR, A.C_DNIACTOR, A.C_RUCACTOR  
        FROM SIMCO_REG_ACTOR A 
        LEFT JOIN SIMCO_UBIGEO_DPTO B ON A.C_IDDEPARTAMENTO = B.C_ID_DPTO
        LEFT JOIN SIMCO_REG_ACTIVIDAD_ACTOR C ON A.N_ID_ACTOR = C.N_ID_ACTOR
        LEFT JOIN SIMCO_REG_CASO_ACTIVIDAD D ON C.N_ID_ACTIVIDAD = D.N_ID_ACTIVIDAD
        LEFT JOIN SIMCO_REG_CASO E ON D.N_ID_CASO = E.N_ID_CASO AND E.C_INDVIGENTE= 'A'
        LEFT JOIN (
        SELECT A2.C_TIPOACONTECIMIENTO, B2.N_ID_CASO, A2.N_ID_ACTIVIDAD FROM SIMCO_REG_ACTIVIDAD A2
        INNER JOIN SIMCO_REG_CASO_ACTIVIDAD B2 ON A2.N_ID_ACTIVIDAD = B2.N_ID_ACTIVIDAD
        ) F ON E.N_ID_CASO = F.N_ID_CASO 
        WHERE 1 = 1 
        <if test="anho != null">
            AND TO_CHAR(A.D_FECHAREGISTRO, 'YYYY') = TO_CHAR(#{anho}) 
        </if>
        <if test="codigoCaso != ''">
            AND E.C_CODIGOCASO = #{codigoCaso}
        </if>
        <if test="tipologia != null">
            AND E.C_TIPOCASO = #{tipologia} 
        </if>
        <if test="idRegion != null">
            AND E.C_IDDEPART = #{idRegion} 
        </if>
        <if test="estado != null">
            AND E.C_TIPOESTADO = #{estado} 
        </if>
        <if test="tipoAcontecimiento != null">
            AND F.C_TIPOACONTECIMIENTO = #{tipoAcontecimiento} 
        </if>
    </select>
    
    
    <select id="contarActorAcontecimiento" resultType="java.lang.Integer" parameterType="Long">
        SELECT COUNT(DISTINCT A.N_ID_ACTIVIDAD) FROM SIMCO_REG_ACTIVIDAD A
        INNER JOIN SIMCO_REG_ACTIVIDAD_ACTOR B ON A.N_ID_ACTIVIDAD = B.N_ID_ACTIVIDAD
        WHERE A.C_TIPO = 'AC' AND B.N_ID_ACTOR = #{id}
    </select>
    
    
    <select id="contarActorAcuerdoComprometido" resultType="java.lang.Integer" parameterType="Long">
        SELECT COUNT(N_ID_ACUERDO) FROM SIMCO_REG_ACTOR_ACUERDO WHERE N_ID_ACTOR = #{id}
        AND C_INDTIPOACTORACUERDO = 'INI'
    </select>
    
    <select id="contarActorAcuerdoBeneficiario" resultType="java.lang.Integer" parameterType="Long">
        SELECT COUNT(N_ID_ACUERDO) FROM SIMCO_REG_ACTOR_ACUERDO WHERE N_ID_ACTOR = #{id}
        AND C_INDTIPOACTORACUERDO = 'FIN'
    </select>
    
    
    
</mapper>